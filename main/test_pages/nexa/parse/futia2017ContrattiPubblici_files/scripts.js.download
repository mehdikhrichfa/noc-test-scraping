var jq = jQuery, populatemenu_called = false, isLeaveParent = false, lastLeft = null;

jq(function($)
{
	changeMenuBck();
	nexa_fixDateParagraphs();
	hideStatementHeaderBlock();
	nexa_normalizeReadMoreLink();
	nexa_normalizeFormElements();
	if( jq('.expanded').is('li') ) setTimeout(nexa_alignMenuItemToParent, 150);
	nexa_fixLastParaghraphMargin();
	nexa_publicationPage();
	if( jq('div.view-about-gallery').is('div') ) jq('div.view-about-gallery div.view-content').galleryScroll();	
	jq("div#sub-heading-home-statement").nexa_changeBck();
	giveSubtitleImage();
});
function giveSubtitleImage()
{
	var src = Drupal.settings.themepath+"/img/calligrafica.png";
	jq("h2#nexa-statement-heading").text('');
	jq("h2#nexa-statement-heading").html('<img src="'+src+'" />')
}
function changeMenuBck()
{
	var el, anchors = jq('div.headerMainMenuHome').find('a'), container = jq('div.ghostHeaderMenuItem');
	anchors.each(
	
	function(i)
	{	
		jq(this).bind('mouseover', function(event)
		{
			el = jq(this);
			if( typeof(lastLeft) != 'undefined' && lastLeft && null != lastLeft ) lastLeft.css('background', 'rgb(50,51,51)');
			el.css('background', '#657B90');
			isLeaveParent = false;

			container.empty();

			if( !populatemenu_called )
			{
				populateSubNavigationMenuOnHover( el, container );
			}
			jq(".ghostHeaderMenuItem").fadeIn(100, function()
			{
				jq("#sub-heading-home-statement").css('z-index', '1');
				container.css('z-index', '1000');
				removeMenuStuff( container );
			});
		});
		jq(this).bind('mouseleave', function(event)
		{
			lastLeft = jq(this);
			lastLeft.css('background', '#657B90');
			populatemenu_called = false;
		});
	});	
};
function hideStatementHeaderBlock()
{
	jq("#goAway").bind('click', function()
	{
		jq("#sub-heading-home-statement").slideUp('slow', function() {

		});
	});
};

function populateSubNavigationMenuOnHover( element, wrap )
{
	var ul, el = element, send = el.attr('href'), container =  wrap;

	jQuery.ajax({
		url: Drupal.settings.basePath+'populatemenu/populate',
		data: {'menu_url': send},
		type: 'POST',
		success: function(data){
			container.empty();
			populatemenu_called = true;
			if( data )
			{
				var position = el.position(), offset = position.left - 1;
				container.append(data);
				ul = container.find('ul');
				if (offset>700){
					offset=offset-720;
				}
				/*offset = offset - ( ul.width() / ul.children().length );*/
				ul.css({left: offset+"px"});
			}
			else
			{
				el.parent().bind('mouseleave', function(event){
					isLeaveParent = true;
					resetMenuContainer( container );
					el.css('background', 'rgb(50,51,51)');
					jq(this).unbind();
				});
			}
		},
		error: function(jqXHR, textStatus, errorThrown){
			populatemenu_called = true;
		}
	});
};
function removeMenuStuff( container )
{
	jq("#block-system-main-menu").bind('mouseleave', function(event)
	{
		if( !isLeaveParent )
		{
			isLeaveParent = true;
			if( typeof(lastLeft) != 'undefined' && lastLeft && null != lastLeft ) lastLeft.css('background', 'rgb(50,51,51)');
			resetMenuContainer( container );
			jq(this).unbind();
		}
	});	
};
function resetMenuContainer( container )
{
	var c = container;
	c.empty();
	jq("#sub-heading-home-statement").css('z-index', '1000');
	c.fadeOut(300, function(){
		jq("#sub-heading-home-statement").css('z-index', '1000');
	});
};
function nexa_normalizeReadMoreLink()
{
	jq('span.view-node-span a').text("More >");
	jq('span.view-post a').text("More >");
	jq('li.pager-next a').text(" >");
	jq('li.pager-last a').text(">>");
	jq('li.pager-first a').text('<<');
	jq('li.pager-previous a').text('<<');
};
function nexa_normalizeFormElements()
{
	jq('#wrapper #container div#sidebar-left form label').text('search');
	jq('#wrapper #container div#sidebar-left form input[type="submit"]').val('');
	jq('#wrapper #container div#sidebar-left form input').wrapAll('<div class="inputsWrapper" />');
	jq('#wrapper #container div#sidebar-left form input[type="text"]').click(function(){jq(this).val('');});
};
function nexa_fixContentPaddingIfNotSuperSticky()
{
	//code here
};
function nexa_alignMenuItemToParent()
{
	var el = jq('.expanded'), position = el.position(), ul = jq("#header-region #block-system-main-menu div.headerMenuItem ul.menu"), offset = position.left, aref = el.find('a').attr('href');
	
	jq('#header-region #block-system-main-menu .headerMainMenu ul.menu li.expanded a').css('background', '#657B90');
	
	if(aref=='/get-involved'){
		offset = 56;
	}
	
	 if( jq.browser && jq.browser.mozilla )
		{
			switch(aref)
			{
				case '/about':
				offset = 214;
				break;
				case '/people':
				offset = 283;
				break;
				case '/publications':
				offset = 432;
				break;
				case '/events':
				offset = 616;
				break;
				case '/newsroom':
				offset = 684;
				//offset = offset +84;
				break;
				case '/get-involved':
				offset = 56;
				break;
			}
		}
		ul.css({left: offset+"px"}).fadeIn(200,function(){});
};
function nexa_fixDateParagraphs()
{
	if(jq('.dateBoxInside').is('div'))
	{
		var cont = jq('div.view-upcoming-events').parent().parent().addClass('upcoming-events-container'), link = jq('<span class="go-to-events-calendar-span"></span>');
		link.html('apri il <a href="/events" title="events" class="a-go-to-events">calendario eventi</a>');
		cont.append(link);
		jq('.dateBoxInside > p').eq(0).addClass('month_par');
		jq('.dateBoxInside > p').eq(1).addClass('day_par');
		jq('.dateBoxInside > p').eq(2).addClass('year_par');
		var div = jq('div.view-upcoming-events div.views-field-field-luogo-value');
		var txt = jq('div.view-upcoming-events div.views-field-field-luogo-value').text().split('|');
		
		div.each(function(i){
			//console.log('fooo '+jq(this).attr('id'));
			var txt = jq(this).text().split('|');
			if( typeof(txt[1]) != 'undefined' )
					{
						jq(this).html('<span class="where_to">'+txt[0]+'</span><span class="where_address">'+txt[1]+'</span>');
					}
		});
	}
};
function nexa_fixLastParaghraphMargin()
{
	jq('div.field-content').each(function(i){
		var l = jq(this).find('p').length - 1;
		jq(this).find('p').eq(l).css('margin-bottom', '0.2em');	
	});
	jq('.more-link').css('text-align', 'left');
	jq('.more-link a').text('more > ');
	jq('li.views-row-last').css('margin-bottom', '3px');
};
function nexa_imageGalleryInit()
{
	var scrollerButtons = '<span id="previous-button" class="gallery-buttons"> > </span><span id="next-button" class="gallery-buttons"> < </span>', params;
	jq("#block-views-about_gallery-block_1").append( scrollerButtons );
	jq(".view-content").addClass('scrollableArea');
	jq(".view-id-about_gallery").addClass('scrollWrapper');
	params = {

	};
	jq("#block-views-about_gallery-block_1").smoothDivScroll({});
};
function nexa_publicationPage()
{
	jq("div.view-Publications-Nexa-Planet div.view-header").find('p').eq(1).css({'color':'rgb(150,150,150)', 'font-family':'Georgia', 'font-style':'italic'});
	jq('div#block-views-papers-block_1 h2').wrap('<a href="/papers" />').parent().parent().append('<span class="view-node-span"><a href="/papers">more > </a></span>');
	jq('div#block-views-Translations-block_1 h2').wrap('<a href="/translations" />').parent().parent().append('<span class="view-node-span"><a href="/translations">more > </a></span>');
	jq("div.view-Publications-Nexa-Planet").parent().prev().wrap('<a href="/nexa-planet" />').parent().parent().append('<span class="view-node-span"><a href="/nexa-planet">more > </a></span>');
	jq('div#block-views-audio_video-block_1 h2').wrap('<a href="/audio-video" />').parent().parent().append('<span class="view-node-span-audio-video"><a href="/audio-video">more > </a></span>');
};
(function( $ ){
	$.fn.galleryScroll = function() {
		var thumbsNum = this.children().length, imgCont = this.children().eq(0), imgContWidth = imgCont.width() + 12, scrollerButtons = '<div id="previous-button" class="gallery-buttons"></div><div id="next-button" class="gallery-buttons"></div>', el = this, count = 4, control;
		this.parent().append(scrollerButtons);
		
		var previous = function()
		{
			$('#previous-button').bind('click',function(event){
				
				////console.log("c:: "+count+" t:: "+thumbsNum);
				if( count == 4 ) next();
				
				if( count == thumbsNum-1 ) $(this).unbind('click');
				
				el.animate({
					left: '-='+imgContWidth.toString()
				},
				{
					duration: 200,
					easing: 'swing',
					step: function(now, fx) 
					{

					},
					complete: function()
					{

					}
				});
				count++;
			});
		}
		
		var next = function()
		{
			$('#next-button').bind('click',function(event){
				////console.log("c:: "+count+" t:: "+thumbsNum);
			//	////console.log('#previous-button '+control+" "+count);
				
				if( count == 5 ) $(this).unbind('click');
				
				if( count == thumbsNum-1 ) previous();
				
				el.animate({
					left: '+='+imgContWidth.toString()
				},
				{
					duration: 200,
					easing: 'swing',
					step: function(now, fx) 
					{

					},
					complete: function()
					{

					}
				});
				count--;
			});
		}
		previous();
	};
	})( jQuery );
	
(function( $ ){
		$.fn.nexa_changeBck = function() {
			var imgs = ['banner1.jpg', 'banner1.jpg', 'banner2.jpg', 'banner3.jpg', 'banner4.jpg', 'banner4.jpg','banner5.jpg','banner6.jpg','banner7.jpg', 'banner8.jpg'], rnd = Math.round((Math.random() * (8 - 1)) + 1);
			this.css('background', "url('"+Drupal.settings.themepath+"/img/"+imgs[rnd]+"') no-repeat left top #657B90");
		};
		})( jQuery );
		
		
		
//!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");


(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  //js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));		
